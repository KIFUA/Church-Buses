<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Табло використання бусів</title>
    
    <!-- Налаштування для Андроїд додатку -->
    <!-- PWA вимкнено -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#1f2937">

    <!-- Бібліотеки (React та стилі) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- НАЛАШТУВАННЯ ТА ДАНІ ---
        // Додаємо timestamp до URL, щоб уникнути кешування даних таблиці
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQxyzpvfY52YXP2aqyMgI0ku7NuuwLMtQjaJ_Kg_NUX-gzQActOWXliWsHCLXqeEp8GCr3UTo3qC6cF/pub?gid=747631810&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfX_hReaYw7DlCyrHZjQzZ3XQ0VAF3drd62UVu3AN1uS5UYcwhXChIY-Nv6A6l6t2y/exec';

        const BUSES = [
            { code: 'S', name: 'СПРИНТЕР', description: '(16 місць + водій категорії D)', imageUrl: 'https://i.postimg.cc/fR86KGt6/image.png' },
            { code: 'K', name: 'КРАФТЕР', description: '(8 місць + водій категорії В)', imageUrl: 'https://i.postimg.cc/4d9qXnLg/image.png' },
            { code: 'D', name: 'ДЕЛЬФІН', description: '(8 місць + водій категорії В)', imageUrl: 'https://i.postimg.cc/jj9BVyhc/image.png' }
        ];

        const MONTH_NAMES = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
        const WEEK_DAYS = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Нд'];

        // --- ДОПОМІЖНІ ФУНКЦІЇ ---
        const parseCsvLine = (line) => {
            const values = [];
            let inQuotes = false, currentField = '';
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { values.push(currentField); currentField = ''; }
                else currentField += char;
            }
            values.push(currentField);
            return values;
        };

        const parseTripsData = (text) => {
            return text.split('\n').slice(1).map(line => {
                const v = parseCsvLine(line.trim());
                if (v.length > 6) return {
                    bus: v[3]?.trim() || '', departureDate: v[4]?.trim() || '', returnDate: v[6]?.trim() || '',
                    purpose: v[7]?.trim() || '', destination: v[8]?.trim() || ''
                };
                return null;
            }).filter(Boolean);
        };

        const parseDate = (str) => {
            if (!str) return null;
            const parts = str.trim().split(' ')[0].split('.');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            return null;
        };

        const isDateInRange = (date, start, end) => {
            if (!start || !end) return false;
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            return d >= new Date(start.getFullYear(), start.getMonth(), start.getDate()) && 
                   d <= new Date(end.getFullYear(), end.getMonth(), end.getDate());
        };

        // --- КОМПОНЕНТИ ---
        const BusCard = ({ bus, isActive, onClick, isMobileFloating }) => {
            if (isMobileFloating) {
                return (
                    <div onClick={onClick} className={`cursor-pointer transition-all duration-300 p-1 rounded-lg ${isActive ? 'bg-white/90 shadow-lg scale-105 border-2 border-blue-500' : 'bg-white/60'}`}>
                        {/* Розмір іконок 98x50 */}
                        <img src={bus.imageUrl} alt={bus.name} className="w-[98px] h-[50px] object-contain" />
                    </div>
                );
            }
            return (
                <div onClick={onClick} className={`cursor-pointer transition-all bg-gray-100 rounded-lg p-3 flex flex-col items-center min-w-[140px] ${isActive ? 'border-2 border-blue-500 shadow-md' : 'border-2 border-transparent hover:shadow-lg'}`}>
                    <img src={bus.imageUrl} alt={bus.name} className="w-[98px] h-[50px] object-contain mb-2" />
                    <span className="font-bold text-gray-800">{bus.name}</span>
                    <span className="text-xs text-gray-500">{bus.description}</span>
                </div>
            );
        };

        const Calendar = ({ month, year, trips, busCode, onDayClick, onDayHover, onDayLeave, onMonthChange, showControls }) => {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay() || 7;
            const days = Array.from({ length: startDay - 1 }).fill(null).concat(
                Array.from({ length: daysInMonth }, (_, i) => {
                    const date = new Date(year, month, i + 1);
                    return { date, day: i + 1, dateStr: `${String(i + 1).padStart(2,'0')}.${String(month + 1).padStart(2,'0')}.${year}` };
                })
            );

            const getTrip = (day) => {
                if (!day || !busCode) return null;
                return trips.find(t => t.bus.includes(busCode) && isDateInRange(day.date, parseDate(t.departureDate), parseDate(t.returnDate)));
            };

            return (
                <div className="bg-gray-100 rounded-lg shadow-md p-2 w-full max-w-[300px]">
                    <div className="flex justify-between items-center mb-2">
                        <button onClick={() => showControls && onMonthChange(-1)} className={`font-bold px-2 ${!showControls && 'invisible'}`}>&lt;</button>
                        <h3 className="font-bold text-red-500">{MONTH_NAMES[month]}</h3>
                        <button onClick={() => showControls && onMonthChange(1)} className={`font-bold px-2 ${!showControls && 'invisible'}`}>&gt;</button>
                    </div>
                    <div className="grid grid-cols-7 gap-[1px] text-center text-[11px]">
                        {WEEK_DAYS.map((d, i) => <div key={d} className={`font-bold ${i>4 ? (i===5?'text-blue-500':'text-red-500'):'text-gray-600'}`}>{d}</div>)}
                        {days.map((d, i) => {
                            const trip = d ? getTrip(d) : null;
                            const isToday = d && d.date.toDateString() === new Date().toDateString();
                            return (
                                <div key={i} 
                                    onClick={() => trip && onDayClick(trip)}
                                    onMouseEnter={(e) => trip && onDayHover(trip, e)}
                                    onMouseLeave={onDayLeave}
                                    className={`h-6 flex items-center justify-center rounded font-bold ${!d ? '' : trip ? 'bg-red-500 text-white cursor-pointer' : 'text-gray-800'} ${isToday && !trip ? 'ring-2 ring-blue-500' : ''}`}
                                >
                                    {d ? d.day : ''}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const DatePickerField = ({ label, value, onChange }) => {
            const inputRef = React.useRef(null);
            const formatDateDisplay = (dateStr) => {
                if (!dateStr) return '';
                const [year, month, day] = dateStr.split('-');
                return `${day}.${month}.${year}`;
            };
            const handleIconClick = () => {
                if (inputRef.current) {
                    inputRef.current.showPicker();
                }
            };
            return (
                <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                    <div className="relative">
                        <input
                            type="text"
                            readOnly
                            className="w-full border p-2 rounded pr-10 cursor-pointer bg-white"
                            placeholder="дд.мм.рррр"
                            value={formatDateDisplay(value)}
                            onClick={handleIconClick}
                        />
                        <input
                            ref={inputRef}
                            type="date"
                            className="absolute inset-0 opacity-0 cursor-pointer"
                            value={value}
                            onChange={onChange}
                        />
                        <svg
                            onClick={handleIconClick}
                            className="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 cursor-pointer pointer-events-auto"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
            );
        };

        const BookingForm = ({ busCode, onBack, onSuccess }) => {
            const [form, setForm] = React.useState({ responsible: '', start: '', end: '', s: 'Не замовляємо', k: 'Не замовляємо', d: 'Не замовляємо' });
            const [status, setStatus] = React.useState('IDLE');
            const [uid, setUid] = React.useState(null);

            const handleFocus = (f) => form[f] === 'Не замовляємо' && setForm({...form, [f]: ''});
            const handleBlur = (f) => form[f] === '' && setForm({...form, [f]: 'Не замовляємо'});

            const submit = async () => {
                if (!form.responsible || !form.start || !form.end) return alert('Заповніть всі поля!');
                setStatus('LOADING');
                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST', body: JSON.stringify({
                            bus: BUSES.find(b=>b.code===busCode)?.name, responsiblePerson: form.responsible,
                            departureDate: form.start, returnDate: form.end, sprinter: form.s, crafter: form.k, delphin: form.d, userEmail: "app@user"
                        })
                    }).then(r => r.json());
                    if (res.status === 'success') { setUid(res.uniqueId); setStatus('WAIT'); } else setStatus('ERR');
                } catch { setStatus('ERR'); }
            };

            React.useEffect(() => {
                if (status !== 'WAIT' || !uid) return;
                const i = setInterval(async () => {
                    const res = await fetch(`${APPS_SCRIPT_URL}?id=${uid}`).then(r => r.json()).catch(() => ({}));
                    if (res.status === 'Підтверджено') setStatus('OK');
                    else if (res.status && res.status !== 'Очікує підтвердження') setStatus('REJECT');
                }, 3000);
                return () => clearInterval(i);
            }, [status, uid]);

            if (status === 'OK') return <div className="text-center p-8"><h2 className="text-2xl text-green-600 font-bold mb-4">Замовлення підтверджено!</h2><button onClick={onSuccess} className="bg-blue-600 text-white px-6 py-2 rounded">Далі</button></div>;

            return (
                <div className="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto space-y-4">
                    <h2 className="text-2xl font-bold text-center">Бронювання</h2>
                    <input className="w-full border p-2 rounded text-center" placeholder="Відповідальний" value={form.responsible} onChange={e=>setForm({...form, responsible: e.target.value})} />
                    <div className="flex gap-2">
                        <DatePickerField label="Виїзд" value={form.start} onChange={e=>setForm({...form, start: e.target.value})} />
                        <DatePickerField label="Повернення" value={form.end} onChange={e=>setForm({...form, end: e.target.value})} />
                    </div>
                    <div className="space-y-2">
                        <div className="flex items-center gap-2"><img src={BUSES[0].imageUrl} className="w-16" /><input className="flex-1 border p-2 rounded" value={form.s} onFocus={()=>handleFocus('s')} onBlur={()=>handleBlur('s')} onChange={e=>setForm({...form, s: e.target.value})} /></div>
                        <div className="flex items-center gap-2"><img src={BUSES[1].imageUrl} className="w-16" /><input className="flex-1 border p-2 rounded" value={form.k} onFocus={()=>handleFocus('k')} onBlur={()=>handleBlur('k')} onChange={e=>setForm({...form, k: e.target.value})} /></div>
                        <div className="flex items-center gap-2"><img src={BUSES[2].imageUrl} className="w-16" /><input className="flex-1 border p-2 rounded" value={form.d} onFocus={()=>handleFocus('d')} onBlur={()=>handleBlur('d')} onChange={e=>setForm({...form, d: e.target.value})} /></div>
                    </div>
                    {status === 'WAIT' && <div className="text-yellow-600 text-center animate-pulse">Очікування підтвердження...</div>}
                    {status === 'REJECT' && <div className="text-red-600 text-center font-bold">Відмовлено.</div>}
                    <div className="flex gap-2"><button onClick={onBack} className="flex-1 bg-gray-200 py-2 rounded">Назад</button><button onClick={submit} disabled={status==='WAIT'} className="flex-1 bg-blue-600 text-white py-2 rounded">Замовити</button></div>
                </div>
            );
        };

        const App = () => {
            const [trips, setTrips] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [bus, setBus] = React.useState(null);
            const [date, setDate] = React.useState(new Date());
            const [view, setView] = React.useState('HOME');
            const [modal, setModal] = React.useState(null);
            const [hover, setHover] = React.useState(null);
            const [tipPos, setTipPos] = React.useState({x:0,y:0});
            const [floatNav, setFloatNav] = React.useState(false);

            React.useEffect(() => { 
                // Завантаження даних з "анти-кеш" параметром timestamp
                fetch(`${GOOGLE_SHEET_URL}&_t=${Date.now()}`)
                    .then(r=>r.text())
                    .then(t => { setTrips(parseTripsData(t)); setLoading(false); })
                    .catch(e => { console.error(e); setLoading(false); }); 
            }, []);
            
            React.useEffect(() => { 
                const onScroll = () => setFloatNav(bus && window.scrollY > 300);
                window.addEventListener('scroll', onScroll); return () => window.removeEventListener('scroll', onScroll);
            }, [bus]);

            const nextDate = new Date(date.getFullYear(), date.getMonth() + 1, 1);
            const onHover = (trip, e) => {
                if (window.matchMedia('(hover: hover)').matches) {
                    const r = e.target.getBoundingClientRect();
                    setTipPos({ x: r.left + r.width / 2, y: r.top });
                    setHover(trip);
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-white bg-gray-800">Завантаження...</div>;

            return (
                <div className="min-h-screen pb-10">
                    <div className="text-center py-4 border-b border-gray-300 mb-4 bg-white"><span className="text-xs font-bold uppercase tracking-widest text-gray-700">УЦХВЄ М. ІВАНО-ФРАНКІВСЬК</span></div>
                    <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden min-h-[80vh]">
                        <header className="bg-gray-800 p-6 text-center text-white"><h1 className="text-xl font-bold uppercase">ВИКОРИСТАННЯ ЦЕРКОВНИХ БУСІВ</h1></header>
                        <main className="p-4 relative">
                            {view === 'HOME' && (
                                <>
                                    <div className="flex flex-col items-center mb-6">
                                        <h2 className="font-bold text-gray-800 mb-4">Оберіть бус:</h2>
                                        <div className="flex flex-wrap justify-center gap-4">
                                            {BUSES.map(b => <BusCard key={b.code} bus={b} isActive={bus === b.code} onClick={() => { setBus(b.code); setTimeout(()=>document.getElementById('cal')?.scrollIntoView({behavior:'smooth'}),100); }} />)}
                                        </div>
                                    </div>
                                    {bus && (
                                        // Відступ pl-[108px] для календаря при активному плаваючому меню
                                        <div id="cal" className={`transition-all duration-300 ${floatNav ? 'pl-[108px] sm:pl-0' : ''}`}>
                                            <div className="flex flex-wrap justify-center gap-8">
                                                <Calendar month={date.getMonth()} year={date.getFullYear()} trips={trips} busCode={bus} onDayClick={setModal} onDayHover={onHover} onDayLeave={()=>setHover(null)} onMonthChange={d=>setDate(new Date(date.getFullYear(), date.getMonth()+d, 1))} showControls />
                                                <Calendar month={nextDate.getMonth()} year={nextDate.getFullYear()} trips={trips} busCode={bus} onDayClick={setModal} onDayHover={onHover} onDayLeave={()=>setHover(null)} />
                                            </div>
                                            <div className="text-center mt-6"><button onClick={() => setView('BOOKING')} className="bg-green-600 text-white font-bold py-3 px-8 rounded shadow-lg">Забронювати</button></div>
                                        </div>
                                    )}
                                </>
                            )}
                            {view === 'BOOKING' && <BookingForm busCode={bus} onBack={() => setView('HOME')} onSuccess={() => setView('ORDER')} />}
                            {view === 'ORDER' && <div className="text-center p-8"><h2 className="font-bold text-2xl mb-4">Оформлення</h2><p>Тут буде форма деталей.</p><button onClick={()=>setView('BOOKING')} className="bg-gray-200 px-4 py-2 rounded mt-4">Назад</button></div>}
                        </main>
                    </div>
                    
                    <div className={`fixed left-0 top-1/2 -translate-y-1/2 z-40 p-1 flex flex-col gap-2 transition-transform duration-300 ${floatNav && view === 'HOME' ? 'translate-x-0' : '-translate-x-full'}`}>
                        {BUSES.map(b => <BusCard key={b.code} bus={b} isActive={bus === b.code} onClick={() => setBus(b.code)} isMobileFloating />)}
                    </div>

                    {modal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4" onClick={() => setModal(null)}>
                            <div className="bg-white p-6 rounded-lg w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-xl mb-4">Деталі поїздки</h3>
                                <div className="space-y-2">
                                    <p><strong>Куди:</strong> {modal.destination}</p>
                                    <p><strong>Мета:</strong> {modal.purpose}</p>
                                    <p className="bg-gray-100 p-2 rounded">{modal.departureDate} — {modal.returnDate}</p>
                                </div>
                                <button onClick={() => setModal(null)} className="mt-4 w-full bg-gray-200 py-2 rounded">Закрити</button>
                            </div>
                        </div>
                    )}

                    {hover && (
                        <div className="fixed z-50 bg-white p-2 rounded shadow-xl border text-xs pointer-events-none" style={{ top: tipPos.y - 10, left: tipPos.x, transform: 'translate(-50%, -100%)' }}>
                            <p><strong>Куди:</strong> {hover.destination}</p>
                            <p><strong>Мета:</strong> {hover.purpose}</p>
                            <p>{hover.departureDate} — {hover.returnDate}</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
</body>
</html>
