<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Табло використання бусів</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Church Bus">
    <meta name="theme-color" content="#1f2937">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .datepicker-dropdown { position: absolute; z-index: 100; background: white; border: 1px solid #d1d5db; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 280px; margin-top: 4px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2563eb; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- НАЛАШТУВАННЯ ---
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQxyzpvfY52YXP2aqyMgI0ku7NuuwLMtQjaJ_Kg_NUX-gzQActOWXliWsHCLXqeEp8GCr3UTo3qC6cF/pub?gid=747631810&single=true&output=csv';
        
        // КРОК 2: ВСТАВТЕ ВАШЕ ПОСИЛАННЯ (З ГУГЛ ТАБЛИЦІ) МІЖ ЛАПКАМИ НИЖЧЕ:
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyauGdabXltyOf7YJeZLI9y7IK3BIGTZRjPSUvALXMm-_-PFplgH-FXIJ2WzYQ2xcVC/exec;

        const BUSES = [
            { code: 'S', name: 'СПРИНТЕР', description: '(16 місць + водій категорії D)', imageUrl: 'https://i.postimg.cc/fR86KGt6/image.png' },
            { code: 'K', name: 'КРАФТЕР', description: '(8 місць + водій категорії В)', imageUrl: 'https://i.postimg.cc/4d9qXnLg/image.png' },
            { code: 'D', name: 'ДЕЛЬФІН', description: '(8 місць + водій категорії В)', imageUrl: 'https://i.postimg.cc/jj9BVyhc/image.png' }
        ];

        const MONTH_NAMES = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 'Люпень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
        const WEEK_DAYS = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Нд'];

        const formatDateForDisplay = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
        };

        const parseCsvLine = (line) => {
            const values = [];
            let inQuotes = false, currentField = '';
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { values.push(currentField); currentField = ''; }
                else currentField += char;
            }
            values.push(currentField);
            return values;
        };

        const parseTripsData = (text) => {
            return text.split('\n').slice(1).map(line => {
                const v = parseCsvLine(line.trim());
                if (v.length > 4) return {
                    responsible: v[2]?.trim() || '',
                    bus: v[3]?.trim() || '',
                    departureDate: v[4]?.trim() || '',
                    returnDate: v[6]?.trim() || '',
                    purpose: v[7]?.trim() || '',
                    destination: v[8]?.trim() || ''
                };
                return null;
            }).filter(Boolean);
        };

        const parseDate = (str) => {
            if (!str) return null;
            const match = str.match(/(\d{2})\.(\d{2})\.(\d{4})/);
            return match ? new Date(match[3], match[2] - 1, match[1]) : null;
        };

        const isDateInRange = (date, start, end) => {
            if (!start || !end) return false;
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            return d >= new Date(start.getFullYear(), start.getMonth(), start.getDate()) && 
                   d <= new Date(end.getFullYear(), end.getMonth(), end.getDate());
        };

        const CustomDatePicker = ({ value, onChange, label }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const [viewDate, setViewDate] = React.useState(value ? new Date(value) : new Date());
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                const handleClickOutside = (e) => { if (containerRef.current && !containerRef.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const startDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay() || 7;
            const days = Array.from({ length: startDay - 1 }).fill(null).concat(Array.from({ length: daysInMonth }, (_, i) => i + 1));

            const selectDate = (day) => {
                const newDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
                onChange(newDate.toISOString().split('T')[0]);
                setIsOpen(false);
            };

            return (
                <div className="relative w-full" ref={containerRef}>
                    <label className="text-[11px] font-semibold text-gray-600 uppercase mb-1 block">{label}</label>
                    <div onClick={() => setIsOpen(!isOpen)} className="w-full bg-white border-2 border-gray-500 p-2 rounded cursor-pointer flex justify-between items-center">
                        <span className={value ? 'text-gray-900 font-medium' : 'text-gray-400'}>{value ? formatDateForDisplay(value) : 'дд.мм.рррр'}</span>
                        <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" strokeWidth="2" /></svg>
                    </div>
                    {isOpen && (
                        <div className="datepicker-dropdown p-3 animate-fade-in">
                            <div className="flex justify-between items-center mb-3">
                                <button onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1))} className="p-1">←</button>
                                <span className="font-bold">{MONTH_NAMES[viewDate.getMonth()]} {viewDate.getFullYear()}</span>
                                <button onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1))} className="p-1">→</button>
                            </div>
                            <div className="grid grid-cols-7 gap-1 text-center text-[10px] mb-2">{WEEK_DAYS.map(d => <div key={d} className="font-bold">{d}</div>)}</div>
                            <div className="grid grid-cols-7 gap-1">{days.map((day, i) => <div key={i} onClick={() => day && selectDate(day)} className={`h-8 flex items-center justify-center rounded-full text-xs cursor-pointer ${day ? 'hover:bg-gray-100' : ''} ${value && day && new Date(value).getDate() === day && new Date(value).getMonth() === viewDate.getMonth() ? 'bg-blue-600 text-white' : ''}`}>{day || ''}</div>)}</div>
                        </div>
                    )}
                </div>
            );
        };

        const Calendar = ({ month, year, trips, busCode, onDayClick, onMonthChange, showControls }) => {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay() || 7;
            const days = Array.from({ length: startDay - 1 }).fill(null).concat(Array.from({ length: daysInMonth }, (_, i) => i + 1));
            return (
                <div className="bg-gray-100 rounded-lg shadow-md p-2 w-full max-w-[300px]">
                    <div className="flex justify-between items-center mb-2">
                        {showControls ? <button onClick={() => onMonthChange(-1)} className="font-bold px-2">&lt;</button> : <div className="w-6"></div>}
                        <h3 className="font-bold text-red-500 text-sm uppercase">{MONTH_NAMES[month]}</h3>
                        {showControls ? <button onClick={() => onMonthChange(1)} className="font-bold px-2">&gt;</button> : <div className="w-6"></div>}
                    </div>
                    <div className="grid grid-cols-7 gap-[1px] text-center text-[10px]">
                        {WEEK_DAYS.map(d => <div key={d} className="font-bold pb-1 text-gray-600">{d}</div>)}
                        {days.map((day, i) => {
                            const d = day ? new Date(year, month, day) : null;
                            const trip = d && trips.find(t => t.bus.includes(busCode) && isDateInRange(d, parseDate(t.departureDate), parseDate(t.returnDate)));
                            return <div key={i} onClick={() => trip && onDayClick(trip)} className={`h-7 flex items-center justify-center rounded font-bold text-[11px] ${!day ? '' : trip ? 'bg-red-500 text-white cursor-pointer' : 'text-gray-800'}`}>{day || ''}</div>;
                        })}
                    </div>
                </div>
            );
        };

        const BookingForm = ({ busCode, onBack, onSuccess }) => {
            const [form, setForm] = React.useState({ responsible: '', start: '', end: '', purpose: '', s: 'Не замовляємо', k: 'Не замовляємо', d: 'Не замовляємо' });
            const [status, setStatus] = React.useState('IDLE');
            const [requestId, setRequestId] = React.useState(null);

            React.useEffect(() => {
                let interval;
                if (status === 'WAITING' && requestId) {
                    interval = setInterval(async () => {
                        const res = await fetch(`${APPS_SCRIPT_URL}?action=checkStatus&id=${requestId}`).then(r => r.json());
                        if (res.status === 'ACCEPTED') { setStatus('ACCEPTED'); clearInterval(interval); }
                        else if (res.status === 'REJECTED') { setStatus('REJECTED'); clearInterval(interval); }
                    }, 5000);
                }
                return () => clearInterval(interval);
            }, [status, requestId]);

            const submit = async () => {
                if (!form.responsible || !form.start || !form.end || !form.purpose) return alert('Заповніть всі поля!');
                setStatus('SENDING');
                const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ bus: BUSES.find(b=>b.code===busCode)?.name, responsiblePerson: form.responsible, departureDate: formatDateForDisplay(form.start), returnDate: formatDateForDisplay(form.end), purpose: form.purpose, sprinter: form.s, crafter: form.k, delphin: form.d }) }).then(r => r.json());
                if (res.status === 'success') { setRequestId(res.requestId); setStatus('WAITING'); } else { alert('Помилка'); setStatus('IDLE'); }
            };

            if (status === 'WAITING') return <div className="text-center p-10"><div className="spinner mx-auto mb-4"></div><h2 className="text-xl font-bold">Чекайте підтвердження адміністратора...</h2><p className="text-sm text-gray-500 mt-2">ID: {requestId}</p></div>;
            if (status === 'ACCEPTED') return <div className="text-center p-10 text-green-600"><h2 className="text-2xl font-bold">✓ ЗАМОВЛЕННЯ ПРИЙНЯТО!</h2><button onClick={onSuccess} className="mt-5 bg-blue-600 text-white px-6 py-2 rounded">На головну</button></div>;
            if (status === 'REJECTED') return <div className="text-center p-10 text-red-600"><h2 className="text-2xl font-bold">✕ ВІДХИЛЕНО</h2><button onClick={() => setStatus('IDLE')} className="mt-5 bg-gray-800 text-white px-6 py-2 rounded">Спробувати ще раз</button></div>;

            return (
                <div className="max-w-md mx-auto space-y-4 p-4 bg-white rounded-lg shadow">
                    <h2 className="text-xl font-bold text-center">БРОНЮВАННЯ</h2>
                    <input className="w-full border-2 border-gray-500 p-2 rounded" placeholder="Відповідальний" value={form.responsible} onChange={e=>setForm({...form, responsible: e.target.value})} />
                    <div className="flex gap-2"><CustomDatePicker label="Виїзд" value={form.start} onChange={v=>setForm({...form, start: v})} /><CustomDatePicker label="Повернення" value={form.end} onChange={v=>setForm({...form, end: v})} /></div>
                    <textarea className="w-full border-2 border-gray-500 p-2 rounded" placeholder="Мета поїздки" value={form.purpose} onChange={e=>setForm({...form, purpose: e.target.value})} rows="2" />
                    <div className="text-center pt-2"><button onClick={submit} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">ЗАМОВИТИ</button><button onClick={onBack} className="mt-2 text-gray-500 text-sm">Скасувати</button></div>
                </div>
            );
        };

        const App = () => {
            const [trips, setTrips] = React.useState([]);
            const [bus, setBus] = React.useState(null);
            const [date, setDate] = React.useState(new Date());
            const [view, setView] = React.useState('HOME');
            const [modal, setModal] = React.useState(null);
            const load = () => fetch(`${GOOGLE_SHEET_URL}&_t=${Date.now()}`).then(r=>r.text()).then(t=>setTrips(parseTripsData(t)));
            React.useEffect(() => { load(); }, []);
            const next = new Date(date.getFullYear(), date.getMonth() + 1, 1);

            return (
                <div className="min-h-screen pb-16">
                    <div className="bg-gray-800 text-white p-4 text-center font-bold uppercase tracking-widest">Використання Бусів</div>
                    <main className="p-4 max-w-4xl mx-auto">
                        {view === 'HOME' && !bus && (
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-10">{BUSES.map(b => <div key={b.code} onClick={()=>setBus(b.code)} className="bg-white p-6 rounded-xl shadow text-center cursor-pointer hover:scale-105 transition-transform"><img src={b.imageUrl} className="h-16 mx-auto mb-2 object-contain" /><h3 className="font-bold">{b.name}</h3></div>)}</div>
                        )}
                        {view === 'HOME' && bus && (
                            <div className="animate-fade-in">
                                <button onClick={()=>setBus(null)} className="mb-4 text-blue-600 font-bold">← Назад до вибору</button>
                                <h2 className="text-2xl font-bold text-center mb-6">{BUSES.find(b=>b.code===bus)?.name}</h2>
                                <div className="flex flex-wrap justify-center gap-6">
                                    <Calendar month={date.getMonth()} year={date.getFullYear()} trips={trips} busCode={bus} onDayClick={setModal} onMonthChange={d=>setDate(new Date(date.getFullYear(), date.getMonth()+d, 1))} showControls />
                                    <Calendar month={next.getMonth()} year={next.getFullYear()} trips={trips} busCode={bus} onDayClick={setModal} />
                                </div>
                                <div className="text-center mt-8"><button onClick={()=>setView('BOOKING')} className="bg-green-600 text-white font-bold py-3 px-10 rounded-xl shadow-lg">ЗАБРОНЮВАТИ</button></div>
                            </div>
                        )}
                        {view === 'BOOKING' && <BookingForm busCode={bus} onBack={()=>setView('HOME')} onSuccess={()=>{setView('HOME'); load();}} />}
                    </main>
                    {modal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={()=>setModal(null)}>
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold border-b pb-2 mb-4">Деталі поїздки</h3>
                                <div className="space-y-2 text-sm">
                                    <p><strong>Відповідальний:</strong> {modal.responsible}</p>
                                    <p><strong>Мета:</strong> {modal.purpose}</p>
                                    <div className="bg-blue-50 p-3 rounded mt-2 font-bold text-center">{modal.departureDate} — {modal.returnDate}</div>
                                </div>
                                <button onClick={()=>setModal(null)} className="w-full bg-gray-200 py-2 rounded mt-6 font-bold">Закрити</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
